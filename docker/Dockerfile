FROM node:16 as base

# Add package file
COPY package*.json ./

# Install deps
RUN npm i

# Copy source
COPY src ./src

# Set environment variables
ARG MONGO_INITDB_ROOT_USERNAME
ARG MONGO_INITDB_ROOT_PASSWORD
ARG MONGO_HOST
ARG MONGO_PORT
ENV MONGO_HOST 127.0.0.1
ENV MONGO_PORT 27017
ENV MONGO_INITDB_ROOT_USERNAME root
ENV MONGO_INITDB_ROOT_PASSWORD root

ARG RABBITMQ_HOST
ARG RABBITMQ_PORT
ENV RABBITMQ_HOST 127.0.0.1
ENV RABBITMQ_PORT 5672
ARG RABBITMQ_DEFAULT_USER
ARG RABBITMQ_DEFAULT_PASS
ENV RABBITMQ_DEFAULT_USER root
ENV RABBITMQ_DEFAULT_PASS root

ENV PORT 8080

# Expose port 8080
EXPOSE $PORT

CMD [ "npm", "run", "dev" ]
